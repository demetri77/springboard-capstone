---
title: "Banking Capstone - Machine Learning Applied"
author: "Demetri Lee"
date: "December 27, 2018"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(caret)
knitr::opts_chunk$set(echo = TRUE)
```

## Trying to predict the success of bank telemarketing

I'm trying to predict the success of telemarketing calls for a bank that's 
selling long-term deposits. A Portuguese retail bank was addressed, with data 
collected from 2008 to 2013, thus including the effects of the recent 
financial crisis of 2008. With 21 features available for analysis, I hope to 
derive knowledge for a model that would confirm how to better focus resources 
towards clients with a high chance of agreeing to registering for extra 
banking services. 

```{r}
bankfull_clean <- read_csv("bankfull_clean.csv", col_types = "ifffffffffiiiifdddddf")

# single value
bankfull_mod <- filter(bankfull_clean, edu_lvl != "illiterate" & cred_default != "yes")
#bankfull_mod 
#bankfull_mod %>% filter(loan == "unknown")
```

I will be treating this a supervised classification problem. While predicting 
whether a customer will subscribe to a new service, I need to find the main 
predictors while developing a model that best expressses a client's decision 
for subscribing. 

## Set Up Model Parameters



Let's start with partitioning the dataset into a training and test set.

```{r partition}
set.seed(13456)
inTrain <- createDataPartition(y=bankfull_clean$subscribed, p=0.75, list=FALSE)
trainData <- bankfull_clean[ inTrain,]
testData  <- bankfull_clean[-inTrain,]

inTrainMOD <- createDataPartition(y=bankfull_mod$subscribed, p=0.75, list=FALSE)
trainDataMOD <- bankfull_mod[ inTrain,]
testDataMOD  <- bankfull_mod[-inTrain,]

#caret::trainControl(method = "cv", number = 2, classProbs = TRUE)
```

## Logistic Regression with CARET

Develop a model for training data. 

```{r logReg}
# develop a model
glm_model_full <- train(subscribed ~ ., data=trainData, method="glm", na.action=na.omit)

glm_model_dur <- train(subscribed ~ duration_sec, data=trainData, method="glm", na.action=na.omit)

# model for client data
#glm_model_test <- train(subscribed ~ age + job + marital, data=trainData, method="glm", na.action=na.omit)


glm_model_mod <- train(subscribed ~ ., data=trainDataMOD, method="glm", na.action=na.omit)

# Variables that cause warning: 
# prediction from a rank-deficient fit may be misleading
# edu_lvl, cred_default
# possibly: loan, edu_lvl

#trControl(sampling) //--for later

summary(glm_model_full)
summary(glm_model_dur)
#summary(glm_model_test)
summary(glm_model_mod)

```

COMPLETELY FILTERED DATASET
```{r}
#bankfull_mod <- bankfull_clean
#bankfull_mod[c(4:7)] <- list(NULL)
#findLinearCombos(bankfull_mod)
```


What can we conclude from the logistic regression model? 

```{r}
summary(glm_model_full) # results with entire variable set
summary(glm_model_dur) # results with just variable duration_sec
```

```{r}
# remove column "loan" and "contacted"
#trainData <- subset(trainData, select = c(age:mortgage, contact_typ:subscribed))

#glm_model_mod <- train(subscribed ~ ., data=trainData, method="glm", na.action=na.omit)

#summary(glm_model_mod)
```


Let's apply our model to the test set.
```{r}
# Which model is best?
glm_predict_full <- predict(glm_model_full, newdata=testData)
glm_predict_dur <- predict(glm_model_dur, newdata=testData)
#glm_prediction <- predict(glm_model_mod, newdata=testData)
```

Here is a confusion matrix, with the results expressing accuracy, sensitivity, 
and specificity.
```{r}
glm_confMatrix <- caret::confusionMatrix(glm_predict_full, testData$subscribed, mode="everything") 

glm_confMatrix
# use metric parameter; F1 or Kappa

# investigate further parameters (eg F1/accuracy score)
# Precision = TP / (TP + FP)
# Recall = TP / (TP + FN)
# F1 = (1+beta^2)*precision*recall/((beta^2 * precision)+recall)
# confMatrix$byClass["F1"]

```


## Random Forest with CARET
```{r rdmForest}
# play with smaller # of rf while playing/testing
rf_model <- caret::train(subscribed~., data=trainData, method="rf",
                         trControl=trainControl(method="cv", number=5))

summary(rf_model)

```


```{r}
rf_prediction <- predict(rf_model, newdata=testData)
```

```{r}
rf_confMatrix <- caret::confusionMatrix(rf_prediction, testData$subscribed, mode="everything")

rf_confMatrix
```

```{r}
write_csv(bankfull_clean, path="bankfull_ml.csv", col_names=TRUE)
```

